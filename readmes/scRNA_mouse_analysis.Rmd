---
title: "Mouse_scRNA_analysis"
output: html_document
date: "2025-03-09"
---

### **Reading in txt file from Single Cell Portal for mouse scRNA data**

```{r}
getwd()
metaData_scDevSC <- read.delim("metaData_scDevSC.txt", header = TRUE, check.names = TRUE)
View(metaData_scDevSC)

metaData_scDevSC <- metaData_scDevSC[-1,] #Remove the first column
```

**So within the metaData file, there is a 'New_cellType' column and a 'library_preparation_protocol_ontology_label' column. The 'library_prep' column corresponds to the name of the RAW counts filenames and the 'New_cellType' contains the cell type that represents. So for downstream cell type clustering, we can first assign the correct cell type via cross-referencing**

```{r}
#Loading in OMIM_dat_expression csv file 
library(data.table)
OMIM_dat_counts <- fread("OMIM_dat_macro_expression_data_mouse.csv", header = TRUE)
View(OMIM_dat_counts)
print(names(OMIM_dat_counts))
#First lets remove all the 'SeuratProject etc....' in the name
```

```{r}
colnames(OMIM_dat_counts) <- gsub("SeuratProject_", "", colnames(OMIM_dat_counts))
print(head(names(OMIM_dat_counts)))

#Going to restructure the column names to fit those found in the 'NAME' column in metaData
colnames(OMIM_dat_counts) <- gsub("filtered.*_", "", colnames(OMIM_dat_counts))
print(head(names(OMIM_dat_counts))) 
#Now looks like this: [2] "GSE153164_RAW..GSM4635072_E11_5_AAACCTGAGGACGAAA.1"

print((grep("[GSE.*_RAW]", colnames(OMIM_dat_counts))))
colnames(OMIM_dat_counts) <- gsub("GSE.*_RAW_No_KO", "", colnames(OMIM_dat_counts))
print(head(names(OMIM_dat_counts)))
#Now looks like this: [2] "..GSM4635072_E11_5_AAACCTGAGGACGAAA.1"

#Removing the ..GSM bit 
colnames(OMIM_dat_counts) <- gsub("^\\.\\.GSM[0-9]+_", "", colnames(OMIM_dat_counts))
print(head(names(OMIM_dat_counts))) #[1] "E11_5_AAACCTGAGGACGAAA.1" - finally somewhat matches the ones seen in the 'NAME' column in the metaData file 

#Removing the '.1' at the end
colnames(OMIM_dat_counts) <- gsub("\\.1$", "", colnames(OMIM_dat_counts))

```

**Editing the 'NAME' entries in metaData_DevSC file to match the colnames in OMIM_dat_counts**
```{r}
#Removing the 'v1' in the 'NAME' entries in the metaData_scDevSC
v1_NAME <- (subset(metaData_scDevSC, grepl("v1", metaData_scDevSC$NAME)))
head(v1_NAME)
dim(v1_NAME) #[1] there are 1495 entries 

metaData_scDevSC$NAME <- gsub("v1_", "", metaData_scDevSC$NAME)
View(metaData_scDevSC)
print(head(metaData_scDevSC)) #[1] E10_AAACCTGAGGGTCTCC-1 - now the v1 and the extra _ is removed


#Removing the "-1 bit to match those in OMIM_dat
metaData_scDevSC$NAME <- gsub("-1", "", metaData_scDevSC$NAME)
print(head(metaData_scDevSC))

print(head(metaData_scDevSC))
```


```{r}
missing_ids <- setdiff(colnames(OMIM_dat_counts), metaData_scDevSC$NAME)
print(missing_ids)
missing_ids <- as.data.frame(missing_ids) #There are 17,988 entries that are missing from the metaData_scDevSC file that are found in the counts matrix 
View(missing_ids)

missing_ids_df <- metaData_scDevSC[metaData_scDevSC$NAME %in% missing_ids, ]
View(missing_ids_df)
```




#Using two methods to generate a HeatMap - Without and With Seurat 
## **1.Using standard R to generate Heatmap**

### **Mapping Cell Types to Cell IDs**
```{r}
cell_IDs <- intersect(colnames(OMIM_dat_counts), metaData_scDevSC$NAME)

#Subsetting the data to only include the matching cell IDs 
gene_names <- (OMIM_dat_counts$V1)
print(head(gene_names))
counts <- as.data.frame(OMIM_dat_counts)
counts <- counts[, colnames(counts) %in% cell_IDs]
rownames(counts) <- gene_names

metadata <- metaData_scDevSC[metaData_scDevSC$NAME %in% cell_IDs, ]

print(cell_IDs)
View(counts)
View(metadata)
```


**One problem, I have yet to be able to download the scale.data so I am currently using normalized data BUT NOT z-score normalized**
### **Z-score Normalization of 'OMIM_dat_counts' row**
```{r}
scaled_counts <- t(scale(t(counts)))
head(scaled_counts)

View(scaled_counts)

write.csv(scaled_counts, file = "z_scaled_OMIM_counts.csv", row.names = TRUE)

```


```{r}
#Subsetting metadata file again to include only cell type and NAME
new_cellTypes <- unique(metadata$New_cellType)
print(new_cellTypes)
metadata$Gral_cellType

metadata_subset <- metadata[metadata$NAME %in% cell_IDs, c("NAME", "New_cellType", "Gral_cellType")]
View(metadata_subset)

write.csv()
```

### **Pseudobulk analysis**
```{r}
#Aggregating by cell type
library(Matrix)

counts_aggregate <- aggregate(t(scaled_counts), grouping())



aggr_counts <- aggregate.Matrix(t(counts(sce)), 
                                groupings = groups, fun = "sum") 
```



## **2. Using Seurat's TransferData to Map CellType to Cell ID's in OMIM_gene_counts**
**Ask for help with this - Not too sure if the seurat.query structure is correct.**
```{r}
library(Seurat)
library(SeuratObject)
library(Matrix)

OMIM_dat_counts_mat <- as.matrix(OMIM_dat_counts)
metaData_scDevSC_mat <- as.matrix(metaData_scDevSC)

typeof(OMIM_dat_counts_mat)
print(is.na(OMIM_dat_counts_mat))

#Create Seurat Objects
seurat.query <- CreateSeuratObject(counts = OMIM_dat_counts_mat, assay = 'v3')
seurat.ref <- CreateSeuratObject(counts = metaData_scDevSC)

View(seurat.query)

#FindTransferAnchors 
anchors <- FindTransferAnchors(reference = seurat.ref)


```
